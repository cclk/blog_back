---
title: 流媒体的音视频同步
date: 2017-08-21 09:22:32
categories:
reward: false
tags:
     - blog
     - 音视频
---

## 背景
播放音视频过程中，每一帧音频或视频都有一个持续时间，并且声音同画面要一致。一般在播放端，音视频渲染都需要消耗一定的系统资源，所以在正常情况下，会将音视频的渲染分为多个线程去处理。这就要求对音视频播放的开始和持续时间有要求，才能保证画面同声音同步并且画面流畅。

## 根据音频去同步视频
在windows端，声音的播放是需要连续的，并且调用系统API接口时，会等到音频播放完毕才会通知上层应用。所以在windows端音频播放有以下几个特点：
+ 必须连续，反之则存在噪声（如滋滋声、电流声）
+ 播放时间是固定的，播放完毕才会通知上应用

由上可知，在windows端，声音的播放时间是相对固定的，并且为了减少噪音，我们需要尽量不丢掉音频数据，所以我们可以根据音频播放的时间，去进行音视频同步。

## 可能存在的几种情况
实际应用中，根据音频来同步视频可能存在以下几个情况：
+ 网络拥塞时，可能会导致音频播放完毕，但新的音频数据没有到达
+ 网络拥塞时，可能会导致视频播放完毕，但新的视频数据没有到达
+ 系统声卡故障，导致音频播放会比正常稍慢，导致后续一直积累数据
+ 系统显卡故障，导致视频渲染耗时过多，导致后续一直积累数据
+ 只有视频，没有音频
+ 系统时钟相差过大，如采集端可能已经过去相对时间A1ms，但播放端相对时间为A2ms，两者相差较大

<!--more-->

## 流程图
关键流程如下图：

![](http://ooid5jqhw.bkt.clouddn.com/pts.jpg)

从上图可了解，上述几种情况，可作如下处理：
+ 网络拥塞时：缓存适当的音视频数据，如果还无法解决，降低码流
+ 渲染慢：音频加快渲染速度，视频丢弃渲染数据
+ 无音频：通过pts的相对时间差修正渲染时长
+ 系统时钟相差大：定时进行时钟矫正
